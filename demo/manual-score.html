<html lang="zh-cn">
  <head>
    <meta charset="UTF-8">
    <title>Gemt Score Testbed - from MIDI files</title>
    <!-- -->
    <script type="text/javascript" src="../build/gemt.js"> </script>
    <script type="text/javascript" src="../svg/pic-svg.js"> </script>
    <script type="text/javascript" src="../src/impl/gemt-implement.js"> </script>
    <!-- >
    <script type="text/javascript" src="gemt-min.js"> </script>
    <!-->
    <script type="text/javascript" src="js/jquery-3.5.1.min.js"> </script>
    <script type="text/javascript" src="js/pageutils.js"> </script>
    <script type="text/javascript" src="js/melody.js"> </script>
  </head>
  <body>
      <center>
          <div>
              <center>
                  <div id="title"></div><br>
                    <a href="#" onClick="prevPage();return false">上一页</a>
                    <span class="pageNum">0/0</span>
                    <a href="#" onClick="nextPage();return false">下一页</a>
              </center>
              <canvas id="myCanvas" width="1200px" height="1200px" style="width:600; height:600"></canvas>
              <center>
                    <a href="#" onClick="prevPage();return false">上一页</a>
                    <span class="pageNum">0/0</span>
                    <a href="#" onClick="nextPage();return false">下一页</a>
              </center>
          </div>
      </center>
    <div id="catalog"> </div>
    <script type="text/javascript">
var Container = document.getElementById("myCanvas");
ctx = Container.getContext("2d");
ctx.scale(2, 2);

gct = new GContext(ctx);
gct.beginBudget(600, 600);

var mi = getParam("mi");
if (mi == null) mi = 4;

makeCatalog(MelodyDict, x=>x.name);

var Melody = MelodyDict[mi];
var clef = new MClef(0, new MTone(Melody.tone));
var mtrk = new MTrack();
var ms = new MScore();
var ts = new MBeat(Melody.min||2, Melody.dem||4);
var bar = new MBar();
bar.beat.start = 0;
bar.timeBeat = ts;
bar.clef = clef;

var option = new EOption().use();
option.set("marginBlank", 20)
      .set("margin", 20)
      .set("marginTitle", 60)
      .set("lengthOfRow", 550)
      .set("pageRender", function(ctx, p){
  for (var i = 0; i <= 600/210; i++) {
    for (var j = 0; j <= 600/210; j++) {
      //Mozaik.draw(ctx, i*210, j*210);
    }
  }
})
      .set("titleRender", function(ctx, p){
  ctx.font="30px Verdana";
  ctx.textBaseline = 'top';
  ctx.textAlign = 'center';
  ctx.fillText(Melody.name, 300, 18);
});

document.getElementById("title").innerHTML = document.title = Melody.name;

function makeMChord() {
    return new MChord(...[...arguments].map(x=>new MNote(x)));
}

function pushNote(ns, tm = 4, nso=null) {
    var ch;
    if (ns == null) {
        ch = new MRest(tm);
    } else {
        if (ns instanceof Array)
            ch = makeMChord(...ns);
        else
            ch = makeMChord(ns);

        // link
        if (nso != null) {
            ch.linkWith(bar.chords[bar.chords.length-nso]);
        }
    }
    ch.beat = new MTimeSlice();
    if (tm instanceof Array) {
        for (var t of tm)
            ch.beat.addTo(ts.denominator/t);
        ch.nths = tm;
        if (tm.n) ch.beat.movTo(0);
    } else {
        ch.beat.movTo(ts.denominator/tm);
    }
    bar = bar.feed(mtrk, ch);
    return ch;
}

function pushMelody(content) {
    for (var e of content) {
        if (e instanceof Array)
            pushNote(...e, e.o);
        else if (e instanceof Object) {
            m = new MMark(e.kind, e.type);
            m.beat = new MTimeSlice().follow(bar.beat);
            bar.feed(mtrk, m);
//        } else {
//            m = new MMark(e);
//            m.beat = new MTimeSlice().follow(bar.beat);
//            bar.feed(mtrk, m);
        }
    }

    mtrk.shift(Melody.base);
    for (var b of mtrk.bars) {
        b.settle();
    }
}


ms.tracks.push(mtrk);
mtrk.bars.push(bar);

//pushMelody([[0,1]]);
pushMelody(Melody);

//var ch = pushNote([0, 4, 7], 8);
//ch = pushNote([0,3,7], 8);
//ch = pushNote([0,4,7,11], 8);
//ch = pushNote([0,4,7,11], 8);
//
//ch = pushNote([0,4,7,11], 8);
//ch = pushNote([4, 8, 11], 8);
//ch = pushNote([4, 11], 8);
//ch = pushNote(8, 8);
//bar = bar.extend(mtrk);
//bar.timeBeat = new MBeat(4);
//ch = pushNote(0, 1);


console.log(ms);

var es = EConvert(ms);
console.log(es);

es.budget(gct, 20, 30);
console.log(gct);

gct.print();
$(".pageNum").text("1/"+(gct.pageYBase.length-1));

//function download(){downloadImage("manual", Container);}
//setTimeout(download, 1000);
    </script>
  </body>
</html>

